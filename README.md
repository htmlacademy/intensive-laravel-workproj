# intensive-laravel-workproj

## Общая концепция

Сервис предоставляет возможность отслеживать прогресс просмотра сериалов и получения списка не просмотренных серий.  
Сериалам можно выставлять оценки, на основании которых формируются рейтинги позволяющие выбрать новые сериалы для просмотра.

### Основные сценарии использования:

- Просмотр списка сезонов и серий выбранного сериала
- Регистрация пользователя
- Составление списка просматриваемых сериалов и списка не просмотренных серий
- Выставление оценки сериалу
- Просмотр рейтинга популярных сериалов, фильтрация по жанрам, поиск по названию
- Комментирование вышедших серий, возможность ответа на комментарии
- Добавление сериала используя id imdb получив информацию из внешнего источника
- Периодическая актуализация информации о сериалах из внешнего источника

## Технические требования

Проект должен разрабатываться на PHP версии 8.0 или выше
(при использовании версии 8.1 соответствующее ограничение должно быть указано в файле composer.json).
Используемая база данных — MySQL 5.7 и выше.  
Разработка верстки и клиентского приложения не требуется. Ожидается только разработка бекенд api приложения.

Все запросы должны сопровождаться отправкой заголовка принимающего json в качестве ответа,
и ответы, как успешные так и об ошибках, должны возвращаться в json формате.

## Описание процессов

### Регистрация пользователя

Регистрация нового пользователя для получения доступа к персональной части сайта.

Пользователь заполняет форму регистрации указав Имя, email, пароль и подтверждение пароля.  
Дополнительно может быть загружен аватар.

**Последовательность действий:**

* Отправка post запроса с данными пользователя на endpoint регистрации.
* Валидация полученных полей. Проверка наличия обязательных полей и соответствия заданным правилам.
* Проверка, что указанный email не занят.
* Сохранение данных в БД, или возвращение списка ошибок при их наличии.
* Сохранение аватара в публичное хранилище и указание ссылки на файл в таблице пользователей.
* Авторизация пользователя под зарегистрированной учетной записи

**Правила валидации:**

* Поля email, password, password_confirmation, name - обязательные
* Поле email - должно быть валидным email адресом (валидация средствами фреймворка), не должно использоваться другими пользователями
* Поле password - минимальная длинна 8 символов, должно совпадать с отправленным password_confirmation
* Вместе с формой может быть отправлено изображение размером до 10 мегабайт, в поле под именем file

### Аутентификация

Пользователь заполняет форму авторизации, указав email и пароль.

* Отправка post запроса с данными пользователя на endpoint авторизации.
* Валидация полученных полей. Проверка наличия обязательных полей и соответствия заданным правилам.
* Аутентификация пользователя под учетной записью.

### Обновление профиля пользователя

Пользователь может изменить свои контактные данные и загрузить новый аватар.

Требования к отправляемым данным совпадают с данными отправляемыми на регистрацию.  
Выполняется patch запрос на endpoint обновления профиля.

### Выход (logout)

Пользователь нажимает на кнопку выхода в интерфейсе приложения.

* Отправка post запроса на endpoint выхода пользователя.
* Уничтожение пользовательской сессии

**Примечание:** для реализации методов работы с пользователем авторизация, регистрация и пр -
рекомендуется использовать пакет `laravel/fortify`

### Получение списка сериалов

Пользователь может открыть страницу с сериалами имеющимися на сайте.  
Страница представляет собой список по 20 сериалов, с пагинацией.  
Есть возможность отсортировать список по дате выхода и рейтингу сериала.

Этот же endpoint может использоваться для получения списка сериалов по жанру
и для вывода результатов поиска по имени.

* Отправка get запроса на endpoint получения списка сериалов
* Возвращение первых 20 сериалов, если не передано другое условие (параметр page)
  * Вместе со списком сериалов возвращаются параметры пагинации:
    количество элементов всего ссылка на первую страницу, на последнюю, на предыдущую и следующую

Дополнительно вместе с запросом могут быть переданы следующие параметры:
* page - номер страницы, для пагинации
* order_by - правило сортировки. Возможные значения: date, rating
* order_to - направление сортировки. Возможные значения: asc, desc
* genre - фильтрация по жанру
* search - фильтрация по имени

Если запрос выполняет авторизованный пользователь -
в дополнение к другим параметрам возвращаем статус просмотра и оценку при наличии

### Получение информации о сериале

При открытии страницы сериала пользователь видит карточку сериала,
информацию о дате выхода, рейтинге сериала, список сезонов и эпизодов.

* Отправка get запроса на endpoint получения информации о сериале указав id сериала в качестве параметра адреса

Если запрос выполняет авторизованный пользователь - в дополнение к другим данным, возвращается статус просмотра сериала.

### Получение списка жанров

Технический endpoint. Для формирования списка жанров в форме поиска или каталоге.

* Отправка get запроса на endpoint получения списка жанров

### Получение списка эпизодов сериала

Для отображения на странице сериала списка эпизодов, выполняется отдельный запрос.  
При открытии страницы сериала пользователь видит список эпизодов сгруппированных по сезонам.  
Группировка выполняется на стороне фронтенда.

* Отправка get запроса на endpoint получения списка эпизодов сериала указав id сериала в качестве параметра адреса

Если запрос выполняет авторизованный пользователь -
в дополнение к другим параметрам возвращаем статус просмотра серии

### Получение информации об эпизоде

При клике по эпизоду в списке серий пользователь видит информацию об эпизоде, дату выхода, длительность серии, комментарии.

* Отправка get запроса на endpoint получения информации об эпизоде указав id эпизода в качестве get параметра

Если запрос выполняет авторизованный пользователь -
в дополнение к другим параметрам возвращаем статус просмотра серии

### Получение списка комментариев эпизода

Для отображения на странице эпизода отдельно запрашиваются комментарии.  
Клиентское приложение самостоятельно отвечает за отрисовку комментариев с учетом вложенности, при необходимости.

* Отправка get запроса на endpoint получения списка комментариев эпизода указав id эпизода в качестве get параметра

### Добавление комментария к эпизоду

Пользователь может добавить комментарий к эпизоду, или ответить на другой комментарий.  
Он заполняет соответствующее поле на странице серии, и приложение отправляет запрос на сервер.

* Отправка post запроса на endpoint добавления комментария указав id эпизода в качестве параметра
* Не обязательным параметром может быть отправлен id коментария, если это ответ на другой комментарий

### Получение списка просматриваемых сериалов пользователя

На основной странице пользователя выводится список просматриваемых им сериалов,
и информация о не просмотренных сериях.

* Отправка get запроса на endpoint получения списка сериалов просматриваемых пользователем

Метод возвращает сериалы пользователя без пагинации.  
Вместе с каждым сериалом возвращается информация о количестве просмотренных эпизодов и количестве вышедших серий —
на основании этой информации можно принять решение о необходимости получения списка не просмотренных серий

### Добавление сериала в список просматриваемых

Пользователь может добавить сериал в список просматриваемых со страницы сериала или из поиска, или общих списков.  
При клике на добавление сериала в просматриваемые — отправляется соответствующий запрос к api.

* Отправка post запроса на endpoint добавления сериала в список просматриваемых пользователем

### Удаление сериала из списка просматриваемых

Пользователь может удалить сериал из просматриваемых нажав на соответствующую кнопку на странице сериала.

* Отправка delete запроса на endpoint удаления сериала из списка просматриваемых пользователем

### Добавление эпизода в список просмотренных

После просмотра серии пользователь может отметить эпизод просмотренным.  
Такая функция доступна на странице эпизода, или в списках, где отображаются эпизоды,
например на странице пользователя.

* Отправка post запроса на endpoint добавления эпизода в список просмотренных

### Удаление эпизода из списка просмотренных

Пользователь может удалить эпизод из просмотренных нажав на соответствующую кнопку.  
Кнопка доступна там же где у пользователя была возможность добавить эпизод в просмотренные.

* Отправка delete запроса на endpoint удаления эпизода из списка просмотренных

### Добавление оценки сериалу

На странице сериала пользователь может выставить оценку от 1 до 5.

* Отправка post запроса на endpoint добавления оценки сериалу
* Валидация оценки, на вход ожидается число от 1 до 5

### Получение списка эпизодов отслеживаемого сериала не просмотренных пользователем

Для отрисовки списка не просмотренных эпизодов на странице пользователя
приложение может запросить отдельно соответствующую информацию по api для тех сериалов,
в которых у пользователя есть не просмотренные серии.

* Отправка get запроса на endpoint получения списка эпизодов не просмотренных пользователем

### Запрос на добавление сериала

В дополнение к имеющейся информации на сайте —
пользователь может оставить заявку на добавление отсутствующего сериала в базу.  
Пользователь заполняет форму указав идентификатор сериала с сайта imdb вида tt0944947.  
Заявка на добавление отправляется в очередь и будет выполнена в течение 15 минут или раньше.

* Отправка post запроса на endpoint добавления сериала по imdb id
* Проверка наличия указанного сериала в локальной БД по imdb_id (422 ошибка в случае наличия)
* Создание отложенной задачи на добавление сериала
* Получение информации о сериале по api tvmaze (http://api.tvmaze.com/lookup/shows?imdb=tt0944947)
* Добавление сериала в локальную БД по полученным от tvmaze данным
* Запрос информации об эпизодах и добавление их в БД

**Примечания:**
- при тестировании методов взаимодействующих с внешними сервисами тесты не должны делать реальных запросов. Вместо этого должны использоваться mock запросы, и возвращаться подготовленные фикстуры.
- отложенные задания на добавление сериалов следует лимитировать по к-ву обращений к внешнему api минуту.
- пользовательские задачи должны выполняться в отдельной очереди, что бы избежать блокировки основной очереди приложения.

### Периодическое обновление информации о статусе сериала и эпизодах

Создание периодической задачи которая будет обновлять информацию синхронизируясь с внешним источником

Сценарий работы задачи:
* Получение информации о сериале по api tvmaze
* Синхронизация основной информации полученными от tvmaze данным
* Запрос информации об эпизодах и добавление отсутствующих в БД

**Примечание:** добавление сериала в базу и периодическое обновление могут выполняться с помощью одной и той же задачи,
но должны выполняться в разных очередях.

_Подробнее о принимаемых параметрах и возвращаемых значениях смотрите в api документации проекта_

// todo:  
//        - Добавить информацию об аутентификации используя токены  
